<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="me.zhengjie.modules.system.dao.BusinessLineMapper">

    <resultMap id="businessLineMap" type="me.zhengjie.modules.system.entity.BusinessLineDO">
        <result property="managerId" column="manager_id"/>
        <result property="memberIds" column="member_ids"/>
    </resultMap>

    <insert id="insertBusinessLine" useGeneratedKeys="true"
        keyProperty="id" parameterType="me.zhengjie.modules.system.entity.BusinessLineDO">
        INSERT INTO tbl_sms_businessline_info (name, manager_id, member_ids, context, milestone, rec_crt_ts, rec_upd_ts)
        VALUES (#{name}, #{managerId}, #{memberIds}, #{context}, #{milestone}, current_timestamp , current_timestamp)
    </insert>

    <select id="findByBusinessLineName" resultMap="businessLineMap">
        SELECT * FROM tbl_sms_businessline_info WHERE name = #{name} AND state = 0
    </select>


    <select id="findByBusinessLineId" resultMap="businessLineMap">
        SELECT * FROM tbl_sms_businessline_info WHERE id = #{id}
    </select>

    <update id="deleteBusinessLine">
        UPDATE tbl_sms_businessline_info SET state =1 WHERE id = #{id} AND state = 0
    </update>

    <select id="queryBusinessLineByPage" resultMap="businessLineMap">
        SELECT * FROM tbl_sms_businessline_info
        <where>
            state = 0
            <if test="name!=null and name!=''">
                AND name like concat('%',#{name},'%')
            </if>
            <if test="managerId!=null and managerId!=''">
                AND manager_id = #{managerId}
            </if>
        </where>
        <if test="pageSize != null and pageNum != null">
            limit #{offset}, #{pageSize}
        </if>
    </select>

    <select id="queryBusinessLineTotalCount" resultType="java.lang.Integer">
        select
        count(*)
        from
        (
        select
        *
        from tbl_sms_businessline_info
        <where>
            state = 0
            <if test="name!=null and name!=''">
                AND name like concat('%',#{name},'%')
            </if>
            <if test="managerId!=null and managerId!=''"></if>
        </where>
        ) t1
    </select>

    <select id="findAllBusinessLines" resultMap="businessLineMap">
        SELECT * FROM  tbl_sms_businessline_info WHERE state = 0
    </select>

    <select id="getBusinessLineByName" resultMap="businessLineMap">
        SELECT * FROM  tbl_sms_businessline_info WHERE state = 0 AND name =#{name}
    </select>

    <update id="updateBusinessLine">
        UPDATE tbl_sms_businessline_info
        SET
            name = #{name},
            manager_id = #{managerId},
            member_ids = #{memberIds},
            context = #{context},
            milestone = #{milestone},
            rec_upd_ts=current_timestamp
        WHERE id = #{id} AND state = 0

    </update>

</mapper>
