<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="me.zhengjie.modules.system.dao.mapper.SprintMapper">

    <resultMap id="sprintMap" type="me.zhengjie.modules.system.domain.entity.SprintDO">
        <result property="beginDate" column="begin_date"/>
        <result property="endDate" column="end_date"/>
    </resultMap>


    <insert id="insertSprint"
        keyProperty="id" parameterType="me.zhengjie.modules.system.domain.entity.SprintDO">
        INSERT INTO tbl_sms_sprint_info (name, begin_date, end_date, quarter, rec_crt_ts, rec_upd_ts)
        VALUES (#{name}, #{beginDate}, #{endDate}, #{quarter}, current_timestamp , current_timestamp)
    </insert>

    <select id="findBySprintName" resultMap="sprintMap">
        SELECT * FROM tbl_sms_sprint_info WHERE name = #{name} AND state = 0
    </select>


    <select id="findBySprintId" resultMap="sprintMap">
        SELECT * FROM tbl_sms_sprint_info WHERE id = #{id}
    </select>

    <update id="deleteSprint">
        UPDATE tbl_sms_sprint_info SET state =1 WHERE id = #{id} AND state = 0
    </update>

    <select id="querySprintByPage" resultMap="sprintMap">
    SELECT * FROM tbl_sms_sprint_info
    <where>
        state = 0
        <if test="name!=null and name!=''">
           AND name like concat('%',#{name},'%')
        </if>

        <if test="beginDate!=null">
            <if test="endDate!=null">
                AND
                begin_date BETWEEN #{beginDate} and #{endDate} OR end_date BETWEEN #{beginDate} and #{endDate}
            </if>
        </if>
    </where>
    order by begin_date desc
    <if test="pageSize != null and pageNum != null">
        limit #{offset}, #{pageSize}
    </if>
    </select>


    <select id="querySprintTotalCount" resultType="java.lang.Integer">
        select
        count(*)
        from
        (
        select
        *
        from tbl_sms_sprint_info
        <where>
            state = 0
            <if test="name!=null and name!=''">
                AND name like concat('%',#{name},'%')
            </if>
            <if test="beginDate!=null">
                <if test="endDate!=null">
                    AND
                    begin_date BETWEEN #{beginDate} and #{endDate} OR end_date BETWEEN #{beginDate} and #{endDate}
                </if>
            </if>
        </where>
        ) t1
    </select>

    <update id="updateSprint">
        UPDATE tbl_sms_sprint_info SET name=#{name},
                                       begin_date=#{beginDate},
                                       end_date=#{endDate},
                                       quarter=#{quarter},
                                       rec_upd_ts=current_timestamp
        WHERE id =#{id} AND state = 0
    </update>

    <select id="getSprintByDate" resultMap="sprintMap">
        SELECT * FROM tbl_sms_sprint_info WHERE <![CDATA[ begin_date <= #{Date} ]]> AND <![CDATA[ end_date >= #{Date} ]]>
    </select>
    <select id="findAllByYear" resultMap="sprintMap">
        SELECT * FROM tbl_sms_sprint_info WHERE quarter like concat(#{yyyy},'%') AND state = 0
    </select>

    <select id="getSprintByName" resultMap="sprintMap">
        SELECT * FROM tbl_sms_sprint_info WHERE name =#{name} AND state = 0
    </select>


</mapper>
